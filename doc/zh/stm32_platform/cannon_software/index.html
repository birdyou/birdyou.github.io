<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        <link rel="canonical" href="http://www.juma.io/doc/zh/stm32_platform/cannon_software/">
        <link rel="shortcut icon" href="../../img/jumafav.png">

        <title>JUMA 文档中心</title>

        <link href="../../css/bootstrap.min.css" rel="stylesheet">
        <link href="../../css/font-awesome-4.0.3.css" rel="stylesheet">
        <link href="../../css/prettify.css" rel="stylesheet">
        <link href="../../css/main.css" rel="stylesheet">
        <!--<link href="../../css/table.css" rel="stylesheet">        -->

        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->
    </head>

    <body>

        <div class="navbar navbar-upyun" role="navigation">
    <div class="container clearfix">
        <div class="navbar-header">
            <a class="navbar-brand" href="http://www.juma.io/">JUMA 文档中心</a>
        </div>

        <div class="navbar-collapse collapse pull-right">
            <ul class="nav navbar-nav">
            
              <li class="pull-left">
                
                <a href="../../basics/">文档中心</a>
                
              </li>
            
              <li class="pull-left">
                
                <a href="../../embedded_api/guide/">嵌入式SDK</a>
                
              </li>
            
              <li class="pull-left">
                
                <a href="../../android_api/guide/">Android SDK</a>
                
              </li>
            
              <li class="pull-left">
                
                <a href="../../ios_api/guide/">iOS SDK</a>
                
              </li>
            
              <li class="pull-left">
                
                <a href="../../nrf51_platform/guide/">nRF51平台</a>
                
              </li>
            
              <li class="pull-left active">
                
                <a href="../guide/">STM32平台</a>
                
              </li>
            
<!--                <li>
                    <a href="https://segmentfault.com/upyun" target="_blank">技术问答</a>
                </li>
                <li>
                    <a href="https://blog.upyun.com/" target="_blank">BLOG</a>
                </li>-->
            </ul>

<!--            <ul class="list-unstyled navbar-right clearfix">
                <li class="login"><a href="https://console.upyun.com/#/login/">登录</a></li>
                <li class="reg"><a href="https://console.upyun.com/#/register/">注册</a></li>
            </ul>-->
        </div>
    </div>
</div>


        <div class="container" id="main-wrapper">
            <div class="toolbar clearfix">
  <ol class="breadcrumb pull-left">
    <li><a href="../../basics/">文档</a></li>
    <li>Cannon代码学习</li>
  </ol>

  
    
      <a href="https://github.com/JUMA-IO/JUMA_Docs" class="github-edit pull-right"><i class="fa fa-github"></i> Edit on GitHub</a>
    
  

</div>
            <div class="bs-sidebar hidden-print toc"  data-spy="affix" data-offset-top="120" role="complementary">
  <ul class="nav bs-sidenav">
    
      
        
      

    
      
        
      

    
      
        
      

    
      
        
      

    
      
        
      

    
      
        
          

              <li class="">
                <a class="itm-l1" href="../guide/">使用说明</a>
                
              </li>

          

              <li class="">
                <a class="itm-l1" href="../cannon_resource/">Cannon介绍</a>
                
              </li>

          

              <li class="">
                <a class="itm-l1" href="../cannon_first/">Cannon的第一次</a>
                
              </li>

          

              <li class="">
                <a class="itm-l1" href="../cannon_env/">Cannon开发环境</a>
                
              </li>

          

              <li class="">
                <a class="itm-l1" href="../cannon_burn/">Cannon编译下载</a>
                
              </li>

          

              <li class="active">
                <a class="itm-l1" href="./">Cannon代码学习</a>
                
                  <ul class="nav">
                  
                    <li class="active "><a href="#_1">代码托管</a></li>
<!--                    -->
                  
                    <li class=""><a href="#_2">代码架构</a></li>
<!--                    -->
                  
                    <li class=""><a href="#_3">目录结构</a></li>
<!--                    -->
                  
                    <li class=""><a href="#_4">应用层编程</a></li>
<!--                    -->
                  
                    <li class=""><a href="#_5">贡献代码</a></li>
<!--                    -->
                  
                  </ul>
                
              </li>

          

              <li class="">
                <a class="itm-l1" href="../cannon_lesson_sensor/">Cannon例程: SensorTag</a>
                
              </li>

          

              <li class="">
                <a class="itm-l1" href="../cannon_lesson_led/">Cannon例程: 蓝牙LED</a>
                
              </li>

          

              <li class="">
                <a class="itm-l1" href="../faq/">常见问题</a>
                
              </li>

          
        
      

    
  </ul>


</div>



            <div class="content-body" role="main">

<h1>Cannon代码学习</h1>

<p>本文阐述小钢炮嵌入式代码的架构，然后介绍应用层编程概况，并附上一个简单的例程作为说明。</p>
<hr />
<h2 id="_1">代码托管<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h2>
<p>小钢炮(下称“Cannon”)的代码托管于github，请点击下述链接访问：<br />
<a href="https://github.com/JUMA-IO/STM32_Platform">https://github.com/JUMA-IO/STM32_Platform</a></p>
<p><img alt="" src="../images/cannon_on_github.png" /></p>
<p>打开后的界面如上所述，几点说明：</p>
<ol>
<li>Download ZIP：打包下载整个代码，包含了最新版的提交(Commits)。</li>
<li>Releases：我们会定期发布稳定版。</li>
<li>Commits：代码提交的历史记录。</li>
<li>Watch/Unwatch：如果您想及时获知代码的最新提交(Commits)，点击Watch，会收到邮件通知。</li>
<li>Fork：在Cannon的代码基础上，您可以建立起自己的代码空间，便于您自己的项目开发。</li>
<li>Issues：如果您发现问题，可以给我们提交Bug或建议。</li>
</ol>
<hr />
<h2 id="_2">代码架构<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h2>
<p>小钢炮的嵌入式代码架构如下：</p>
<p><img alt="" src="../images/cannon_archi.png" /></p>
<blockquote>
<p>BLE是Bluetooth Low Energy，低功耗蓝牙的简称。</p>
</blockquote>
<ul>
<li><code>Application Level</code>: 最上层是应用层，开发者通过SDK提供的接口进行编程。</li>
<li><code>Middleware Level</code>: 中间件层，包括了通信协议栈、外设数据(流)接口、各类算法(安全加解密、运动检测等)、文件系统、操作系统或编程框架。</li>
<li><code>Low Level</code>: 底层包括了硬件抽象层(HAL/CMSIS)、外设驱动、板级支持包(BSP)等。</li>
<li>小钢炮的<code>SDK</code>包含了Middleware Level和Low Level两个组建。</li>
<li><code>Hardware</code>: MCU硬件，小钢炮使用的是STM32F4，不过可以将代码移植到其他MCU上。</li>
</ul>
<hr />
<h2 id="_3">目录结构<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h2>
<p>从Github下载好代码后，可以看到代码的目录结构如下：</p>
<p><img alt="" src="../images/cannon_dir.png" /></p>
<p>说明如下：</p>
<ul>
<li><code>/product/applicaton</code>: 应用层示例，比如echo(蓝牙数据回复)、remote_Control(蓝牙遥控)、hum_temp_monitor(温湿度检测)等。</li>
<li><code>/system/bsp</code>: 板级支持包。</li>
<li><code>/system/cmsis</code>: MCU硬件抽象层。</li>
<li><code>/system/drivers</code>: 各类外设驱动。</li>
<li><code>/system/middlewares</code>: 各类中间件，如蓝牙协议栈、算法、文件系统等。</li>
<li><code>/tools</code>: 一些能够配合Cannon使用的辅助工具，如BLE调试助手。</li>
</ul>
<p>童鞋们可以发现，在上述目录下，会有<code>juma</code>或者其他的目录。这是由于Cannon是开源项目，为了保持开放性，需要允许多个组织互不影响的贡献代码。比如一个叫做<code>juma</code>的组织贡献了某驱动, 一个叫做<code>xbar</code>的组织可以贡献同一个设备的另一种写法的驱动，而且可以共存在代码。</p>
<p>所以，目录结构的基本约定是：</p>
<pre><code>    /{subsystem}/{organization}/{module}
</code></pre>

<p>其中，subsystem是由我们定义的子系统，比如驱动子系统、中间件子系统、应用程序子系统、工具子系统。organization是组织的名称，可以是团队、个人、或者公司。module是模块的名称，模块允许有子目录。</p>
<p>比如，下面是一些允许的目录：</p>
<pre><code>    /drivers/juma/lcdXXXX
    /drivers/st/hal
    /applications/juma/sensor_tag
    /middlewares/st/fatfs
    /middlewares/xbar/crypto
    /middlewares/xbar/fuck/you
</code></pre>

<hr />
<h2 id="_4">应用层编程<a class="headerlink" href="#_4" title="Permanent link">&para;</a></h2>
<p>通常情况下，我们只需要关注应用层编程，无需关注SDK内部细节。这也符合SDK设计的初衷，就是让开发者专注做好应用，而把底层的一些通用的、繁琐的、基础的软件实现交给SDK。</p>
<p>以下，我们以<code>echo</code>的例子来介绍应用层编程。</p>
<p><code>echo</code>位于<code>/product/application/juma/echo/app.c</code>。它做的事情是监听蓝牙消息，如果收到手机发送过来的消息，则原封不动的回送给手机。</p>
<pre><code>#include &quot;app.h&quot;

/*start adv*/
char *name = &quot;CAF_ECHO&quot;;
uint8_t adv_address[6] = {0x08, 0x05, 0x04, 0x03, 0x02, 0x04};

void on_ready(void)
{
    uint8_t tx_power_level = 7;
    uint16_t adv_interval = 100;

    /*Config Adv Parameter And Ready to Adv*/
    ble_set_adv_param(name, adv_address, tx_power_level, adv_interval);
    ble_device_start_advertising();
}

/* Device On Message */
void ble_device_on_message(uint8_t type, uint16_t length, uint8_t* value)
{
    /*echo data*/
    ble_device_send(type, length, value);

}
/* Device on connect */
void ble_device_on_connect(void)
{

}

/* Device on disconnect */
void ble_device_on_disconnect(uint8_t reason)
{
    /* Make the device connectable again. */
    Ble_conn_state = BLE_CONNECTABLE;
    ble_device_start_advertising();
}
</code></pre>

<p>代码不长，涉及了一些蓝牙知识，这里简要介绍一下代码流程：</p>
<pre><code>1. 系统就绪 -- on_ready；
2. 设置Cannon的蓝牙广播地址 -- ble_set_adv_param；
3. Cannon开始蓝牙广播 -- ble_device_start_advertising；
4. 手机端APP和Cannon建立连接，假设使用BLE调试助手APP；
5. BLE调试助手APP给Cannon发一些数据；
6. Cannon收到数据后，触发回调事件 -- ble_device_on_message；
7. Cannon将数据原封不动的回传给手机 -- ble_device_send；
8. 手机或Cannon断开连接；
9. Cannon触发断开连接事件 -- ble_device_on_disconnect；
10. Cannon重新开启蓝牙广播 -- ble_device_start_advertising；
</code></pre>

<blockquote>
<p>如果您对蓝牙不熟悉，建议先了解一下蓝牙基本概念，这里有一篇<a href="http://www.juma.io/doc/zh/basics/ble_first/">读物</a>。需记住，收发蓝牙数据，需要先要建立连接，而建立连接，需要设备先开启广播。</p>
</blockquote>
<p><code>echo</code>例程中用到了<code>系统</code>和<code>BLE从设备</code>两个软件模块的API，您可以分别点击API文档查看：</p>
<ul>
<li><code>系统API</code>：<a href="http://www.juma.io/doc/zh/embedded_api/task/">http://www.juma.io/doc/zh/embedded_api/task/</a></li>
<li><code>BLE从设备API</code>：<a href="http://www.juma.io/doc/zh/embedded_api/ble/">http://www.juma.io/doc/zh/embedded_api/ble/</a></li>
</ul>
<blockquote>
<p><code>void on_ready(void)</code>属于<code>系统API</code>，也是应用层编程的第一入口(系统回调事件)，相当于传统的<code>main()</code>函数。</p>
</blockquote>
<p>以上，我们通过<code>echo</code>的代码简要介绍了SDK的应用层编程方式，接下去您可以查阅左侧的其他例程，将会有更丰富的API使用案例。</p>
<hr />
<h2 id="_5">贡献代码<a class="headerlink" href="#_5" title="Permanent link">&para;</a></h2>
<p>我们非常欢迎全国各地的开发者，为Cannon提交代码，不管是修复Bug或是增加Feature，都能让Cannon变得更加完善。</p>
<p>贡献代码采用Github典型的<code>Fork + Pull Request</code>的方式，大致流程为：</p>
<ol>
<li><code>Fork</code> Cannon的代码到自己的空间(<code>repo</code>)；</li>
<li>在自己的<code>repo</code>修改或增加代码；</li>
<li><code>Commit</code>提交代码到自己的<code>repo</code>；</li>
<li>（此时，您的<code>repo</code>和我们的<code>repo</code>应该不一样了）</li>
<li>通过<code>Pull Request</code>向我们提交代码改动申请；</li>
<li>管理员审核通过后，会合并(<code>merge</code>)您改动的代码；</li>
<li>（此时，我们的<code>repo</code>和您的<code>repo</code>就一样了）</li>
</ol>
<blockquote>
<p>关于<code>Fork + Pull Request</code>，这里有一篇<a href="http://www.worldhello.net/gotgithub/04-work-with-others/010-fork-and-pull.html">读物</a>写的不错，您看了就明白了。  </p>
</blockquote>
<p>如果您提交代码，请严格按照<code>目录结构</code>中所约定的规范。比如您叫linus，准备提交一个i2c的驱动，则您的代码应放在<code>/system/drivers/linus/i2c/</code>文件夹下。比如您的组织是zuma，准备提交一个Fat文件系统，则您的代码应放在<code>/system/middlewares/zuma/FatFs</code>文件夹下。</p></div>
        </div>

        

        <script src="../../js/jquery.min.js"></script>
        <script src="../../js/bootstrap.min.js"></script>
        <script src="../../js/prettify.min.js"></script>
        <script src="../../js/main.js"></script>

        <div id="go-top" data-toggle="tooltip" data-placement="bottom" title="回到顶部"><i class="fa fa-arrow-circle-up"></i></div>

        <footer class="footer clearfix">
    <div class="container">
        <ul class="list-unstyled list-inline pull-left">
            <!--<li><a href="/faq/">FAQ</a></li>-->
            <!-- <li><a href="Blog"></a></li> -->
            <li><a href="https://github.com/JUMA-IO">GitHub</a></li>
        </ul>
        <p class="pull-right">&copy; 2015 JUMA</p>
    </div>
</footer>
        <script type="text/javascript">(function(){document.write(unescape('%3Cdiv id="bdcs"%3E%3C/div%3E'));var bdcs = document.createElement('script');bdcs.type = 'text/javascript';bdcs.async = true;bdcs.src = 'http://znsv.baidu.com/customer_search/api/js?sid=6062249992052412388' + '&plate_url=' + encodeURIComponent(window.location.href) + '&t=' + Math.ceil(new Date()/3600000);var s = document.getElementsByTagName('script')[0];s.parentNode.insertBefore(bdcs, s);})();
        </script>
    </body>
</html>